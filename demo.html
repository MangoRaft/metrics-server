<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" href="http://fastly.github.io/epoch/css/epoch.css">
		<script src="http://fastly.github.io/epoch/js/jquery.js"></script>
		<script src="http://fastly.github.io/epoch/js/d3.js"></script>
		<script src="http://fastly.github.io/epoch/js/epoch.js"></script>
	</head>
	<body style="margin:0px;">
		<div id="areaChart" class="epoch category20c" style="width: 100%; height: 200px;"></div>
		<div id="memory" class="epoch category20c" style="width: 100%; height: 200px;"></div>
		<div id="cpu" class="epoch category20c" style="width: 100%; height: 200px;"></div>
		<img src="http://localhost:4003/tracking_pixel.gif?token=demo.onmousemove" />
	</body>

	<script>
		var push = new WebSocket("ws://127.0.0.1:4002/metrics");
		var pull = new WebSocket("ws://127.0.0.1:4001/");
		var chart = {};
		pull.onmessage = function(event) {
			var json = JSON.parse(event.data);
			chart[json.group].push(json.results.map(function(update) {
				return {
					time : update[0],
					y : update[1]
				};
			}));
		};

		$(document).click(function(event) {
			var data = ['demo.onmouseclick', 1, Date.now(), 'inc'];
			push.send(data.join(' '));
		});
		$(document).mousemove(function(event) {
			var data = ['demo.onmousemove', 1, Date.now(), 'inc'];
			push.send(data.join(' '));
		});

		$(function() {

			$.getJSON('http://localhost:4001/metric/demo.onmousemove?from=a minute ago', function(onmousemove) {
				$.getJSON('http://localhost:4001/metric/demo.onmouseclick?from=a minute ago', function(onmouseclick) {
					$.getJSON('http://localhost:4001/metric/demo.memory?from=a minute ago', function(memory) {
						$.getJSON('http://localhost:4001/metric/demo.cpu?from=a minute ago', function(cpu) {
							console.log(cpu.length)

							chart['demo'] = $('#areaChart').epoch({
								type : 'time.line',
								axes : ['right', 'bottom', 'left'],
								data : [{
									label : 'demo.onmouseclick',
									values : onmouseclick.map(function(i) {
										return {
											time : i[0],
											y : i[1]
										};
									})
								}, {
									label : 'demo.onmousemove',
									values : onmousemove.map(function(i) {
										return {
											time : i[0],
											y : i[1]
										};
									})
								}],
								pixelRatio : 1
							});

							pull.send(JSON.stringify({
								event : 'start',
								group : 'demo',
								schema : 'demo.onmouseclick'
							}));
							pull.send(JSON.stringify({
								event : 'start',
								group : 'demo',
								schema : 'demo.onmousemove'
							}));
							pull.send(JSON.stringify({
								event : 'start',
								group : 'memory',
								schema : 'demo.memory'
							}));
							pull.send(JSON.stringify({
								event : 'start',
								group : 'cpu',
								schema : 'demo.cpu'
							}));

							chart['memory'] = $('#memory').epoch({
								type : 'time.line',
								axes : ['right', 'bottom', 'left'],
								data : [{
									label : 'Memory',
									values : memory.map(function(i) {
										return {
											time : i[0],
											y : i[1]
										};
									})
								}],
								pixelRatio : 1
							});
							chart['cpu'] = $('#cpu').epoch({
								type : 'time.line',
								axes : ['right', 'bottom', 'left'],
								data : [{
									label : 'CPU',
									values : cpu.map(function(i) {
										return {
											time : i[0],
											y : i[1]
										};
									})
								}],
								pixelRatio : 1
							});
						});
					});

				});
			});

		});
	</script>
</html>
